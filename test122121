-- Services
local player = game.Players.LocalPlayer
local playerGui = player.PlayerGui
local mouse = player:GetMouse()
local camera = game.Workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local players = game:GetService("Players")

-- Check if 'ScreenGul' exists, if not, create it
local screenGui = playerGui:FindFirstChild("ScreenGul")
if not screenGui then
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ScreenGul"
    screenGui.Parent = playerGui
end

-- Create a smaller, black frame for the GUI
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 200)  -- Smaller size
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
mainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)  -- Black background
mainFrame.BackgroundTransparency = 0.5  -- Slight transparency for a better look
mainFrame.Parent = screenGui

-- Create a button for ESP
local espButton = Instance.new("TextButton")
espButton.Size = UDim2.new(0, 200, 0, 50)
espButton.Position = UDim2.new(0.5, -100, 0, 0)
espButton.Text = "Toggle ESP"
espButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)  -- Red for ESP
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
espButton.Parent = mainFrame

-- Create a button for Aimbot
local aimbotButton = Instance.new("TextButton")
aimbotButton.Size = UDim2.new(0, 200, 0, 50)
aimbotButton.Position = UDim2.new(0.5, -100, 0, 60)
aimbotButton.Text = "Toggle Aimbot"
aimbotButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)  -- Green for Aimbot
aimbotButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
aimbotButton.Parent = mainFrame

-- Handle ESP Toggle
local espEnabled = false
local espParts = {}

espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    print("ESP Enabled:", espEnabled)

    -- Highlight players in red when ESP is enabled
    for _, otherPlayer in pairs(players:GetPlayers()) do
        if otherPlayer ~= player then
            local character = otherPlayer.Character
            if character then
                local head = character:FindFirstChild("Head")
                if head then
                    local espPart = espParts[otherPlayer]

                    -- If ESP is enabled, create ESP part
                    if espEnabled then
                        if not espPart then
                            espPart = Instance.new("BillboardGui")
                            espPart.Name = "ESPPart"
                            espPart.Size = UDim2.new(0, 100, 0, 100)
                            espPart.Adornee = head
                            espPart.AlwaysOnTop = true
                            espPart.Parent = screenGui

                            local frame = Instance.new("Frame")
                            frame.Size = UDim2.new(1, 0, 1, 0)
                            frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)  -- Glow Red
                            frame.BackgroundTransparency = 0.5
                            frame.BorderSizePixel = 0
                            frame.Parent = espPart

                            -- Add Glow Effect
                            local glow = Instance.new("BloomEffect")
                            glow.Intensity = 0.5
                            glow.Size = 24
                            glow.Parent = camera

                            espParts[otherPlayer] = espPart
                        end
                    else
                        -- Remove ESP part when disabled
                        if espPart then
                            espPart:Destroy()
                            espParts[otherPlayer] = nil
                        end
                    end
                end
            end
        end
    end
end)

-- Handle Aimbot Toggle
local aimbotEnabled = false
aimbotButton.MouseButton1Click:Connect(function()
    aimbotEnabled = not aimbotEnabled
    print("Aimbot Enabled:", aimbotEnabled)
end)

-- Function to aim at player's head (Lock on head)
local function aimAtHead(targetPlayer)
    if targetPlayer and targetPlayer.Character then
        local targetHead = targetPlayer.Character:FindFirstChild("Head")
        if targetHead then
            local direction = (targetHead.Position - camera.CFrame.Position).unit
            camera.CFrame = CFrame.new(camera.CFrame.Position, targetHead.Position)  -- Point camera at the target's head
        end
    end
end

-- Function to find the closest player to the center of the screen
local function getClosestPlayerToCenter()
    local closestPlayer = nil
    local closestDistance = math.huge
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)  -- Center of the screen
    
    for _, otherPlayer in pairs(players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local head = otherPlayer.Character:FindFirstChild("Head")
            if head then
                local screenPos, onScreen = camera:WorldToScreenPoint(head.Position)
                if onScreen then
                    local distance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).magnitude
                    if distance < closestDistance then
                        closestPlayer = otherPlayer
                        closestDistance = distance
                    end
                end
            end
        end
    end
    return closestPlayer
end

-- Function to track the player's head while right-click is held
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 and aimbotEnabled then
        -- Lock onto the closest player to the center of the screen when right-click is held
        while UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) do
            local closestPlayer = getClosestPlayerToCenter()
            if closestPlayer then
                aimAtHead(closestPlayer)
            end
            wait(0.1)  -- Update every 0.1 seconds
        end
    end
end)

-- Toggle GUI visibility with Right Shift key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        screenGui.Visible = not screenGui.Visible
    end
end)
