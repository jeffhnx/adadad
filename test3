--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

--// ESP Settings
local ESPEnabled = true
local TeamCheck = true
local RefreshRate = 1 -- Refresh ESP every second
local BoxThickness = 2

--// Function to create ESP for a player
local function CreateESP(player)
    local character = player.Character or player.CharacterAdded:Wait()
    if not character:FindFirstChild("HumanoidRootPart") then return end

    -- Create a BillboardGui for ESP
    local box = Instance.new("BoxHandleAdornment")
    box.Size = character.HumanoidRootPart.Size + Vector3.new(1, 1, 1)
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Transparency = 0.5
    box.Adornee = character.HumanoidRootPart
    box.Parent = character.HumanoidRootPart
    box.Color3 = (TeamCheck and player.Team == LocalPlayer.Team) and Color3.new(0, 1, 0) or Color3.new(1, 0, 0) -- Green for teammates, Red for enemies
    box.Transparency = 0.5
    box.Thickness = BoxThickness

    return box
end

--// Function to refresh ESP
local function RefreshESP()
    while wait(RefreshRate) do
        if ESPEnabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local highlight = player.Character.HumanoidRootPart:FindFirstChildOfClass("BoxHandleAdornment")
                    if not highlight then
                        CreateESP(player)
                    else
                        -- Update team color
                        highlight.Color3 = (TeamCheck and player.Team == LocalPlayer.Team) and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
                    end
                end
            end
        end
    end
end

--// Function to toggle ESP on and off
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.G then
        ESPEnabled = not ESPEnabled
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local highlight = player.Character.HumanoidRootPart:FindFirstChildOfClass("BoxHandleAdornment")
                if highlight then
                    highlight.Visible = ESPEnabled
                end
            end
        end
    end
end)

--// Apply ESP for all players currently in the game
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        player.CharacterAdded:Connect(function()
            CreateESP(player)
        end)

        if player.Character then
            CreateESP(player)
        end
    end
end

--// Refresh ESP every second to account for new players and respawns
coroutine.wrap(RefreshESP)()
