-- Initialize Services
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Camera = game:GetService("Workspace").CurrentCamera
local RunService = game:GetService("RunService")

-- Create the GUI elements
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui  -- Ensure the ScreenGui is placed in the CoreGui

-- Create Aimbot and ESP buttons
local AimbotButton = Instance.new("TextButton")
AimbotButton.Parent = ScreenGui
AimbotButton.Text = "Aimbot: OFF"
AimbotButton.Size = UDim2.new(0, 200, 0, 50)
AimbotButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
AimbotButton.Position = UDim2.new(0.5, -100, 0.5, -60)  -- Centered on screen with offset

local ESPButton = Instance.new("TextButton")
ESPButton.Parent = ScreenGui
ESPButton.Text = "ESP: OFF"
ESPButton.Size = UDim2.new(0, 200, 0, 50)
ESPButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
ESPButton.Position = UDim2.new(0.5, -100, 0.5, 20)      -- Centered on screen with offset below AimbotButton

-- Initially hide the GUI
ScreenGui.Enabled = false  -- Initially hidden

-- Aimbot and ESP state variables
local aimbotEnabled = false
local espEnabled = false
local aimbotTarget = nil  -- To store the target player while Right Click is held
local espPlayers = {}

local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
    AimbotButton.Text = aimbotEnabled and "Aimbot: ON" or "Aimbot: OFF"
    AimbotButton.BackgroundColor3 = aimbotEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

local function toggleESP()
    espEnabled = not espEnabled
    ESPButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    ESPButton.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

AimbotButton.MouseButton1Click:Connect(toggleAimbot)
ESPButton.MouseButton1Click:Connect(toggleESP)

-- Aimbot Function: Lock onto the closest player's head to the center of the screen, adjusted higher
local function aimAtPlayer(target)
    if target and target.Character and target.Character:FindFirstChild("Head") then
        local targetHead = target.Character.Head
        local aimPosition = targetHead.Position + Vector3.new(0, 2, 0)  -- Adjust to aim slightly above the head
        -- Calculate the direction from the camera to the target's adjusted aim position
        local direction = (aimPosition - Camera.CFrame.Position).unit
        -- Set the camera's CFrame to look at the aimPosition (slightly above the head)
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, aimPosition)
    end
end

-- ESP Function: Highlight players and refresh every second
local function highlightPlayers()
    -- Clear previous ESP players
    espPlayers = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Head") then
            local color = player.Team == game.Players.LocalPlayer.Team and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
            -- Create or update ESP for this player
            local headPos = player.Character.Head.Position
            local screenPos = Camera:WorldToScreenPoint(headPos)
            
            -- Add the player to the ESP list for rendering purposes
            table.insert(espPlayers, {
                player = player,
                screenPos = screenPos,
                color = color,
            })
        end
    end
end

-- Update functions: Run every frame to check for Aimbot and ESP
local lastESPUpdate = tick()
RunService.Heartbeat:Connect(function()
    if espEnabled and tick() - lastESPUpdate >= 1 then
        highlightPlayers()
        lastESPUpdate = tick()
    end

    if aimbotEnabled and aimbotTarget then
        aimAtPlayer(aimbotTarget)  -- Aim at the stored target while Right Click is held
    end
end)

-- Toggle GUI visibility with Right Shift key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.RightShift then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

-- Detect Right Mouse Button press and hold to lock aimbot onto closest player
local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2) -- Center of the screen

    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Head") and player ~= game.Players.LocalPlayer then
            local headPos = player.Character.Head.Position
            local screenPos = Camera:WorldToScreenPoint(headPos)
            local distanceToCenter = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude

            -- Track the closest player
            if distanceToCenter < closestDistance then
                closestPlayer = player
                closestDistance = distanceToCenter
            end
        end
    end

    return closestPlayer
end

-- Right Mouse Button Hold to lock aimbot onto the closest player
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right Mouse Button (MouseButton2)
        if aimbotEnabled then
            aimbotTarget = getClosestPlayer()  -- Lock aimbot onto closest player
        end
    end
end)

-- Right Mouse Button Release to stop locking aimbot
UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right Mouse Button (MouseButton2)
        aimbotTarget = nil  -- Stop locking onto any player
    end
end)

-- Highlight ESP when ESP button is clicked
ESPButton.MouseButton1Click:Connect(function()
    highlightPlayers()  -- Refresh ESP list of players
end)

-- Draw ESP for all players in the game
RunService.Heartbeat:Connect(function()
    if espEnabled then
        for _, espPlayer in pairs(espPlayers) do
            local player = espPlayer.player
            local screenPos = espPlayer.screenPos
            local color = espPlayer.color
            
            -- You can add ESP drawing here. For example, display a circle or box around each player.
            -- This is just a simple representation:
            local espLabel = Instance.new("TextLabel")
            espLabel.Text = player.Name
            espLabel.Size = UDim2.new(0, 50, 0, 50)
            espLabel.Position = UDim2.new(0, screenPos.X - 25, 0, screenPos.Y - 25)  -- Center the label
            espLabel.BackgroundTransparency = 1
            espLabel.TextColor3 = color
            espLabel.Parent = ScreenGui
            
            -- Remove the ESP label after a short duration to avoid cluttering
            game.Debris:AddItem(espLabel, 0.1)
        end
    end
end)
