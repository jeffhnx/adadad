-- Initialize Services
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Camera = game:GetService("Workspace").CurrentCamera
local RunService = game:GetService("RunService")

-- Create the GUI elements
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui  -- Ensure the ScreenGui is placed in the CoreGui

-- Create Aimbot and ESP buttons
local AimbotButton = Instance.new("TextButton")
AimbotButton.Parent = ScreenGui
AimbotButton.Text = "Aimbot: OFF"
AimbotButton.Size = UDim2.new(0, 200, 0, 50)
AimbotButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
AimbotButton.Position = UDim2.new(0.5, -100, 0.5, -60)  -- Centered on screen with offset

local ESPButton = Instance.new("TextButton")
ESPButton.Parent = ScreenGui
ESPButton.Text = "ESP: OFF"
ESPButton.Size = UDim2.new(0, 200, 0, 50)
ESPButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
ESPButton.Position = UDim2.new(0.5, -100, 0.5, 20)      -- Centered on screen with offset below AimbotButton

-- Initially hide the GUI
ScreenGui.Enabled = false  -- Initially hidden

-- Aimbot and ESP state variables
local aimbotEnabled = false
local espEnabled = false
local aimbotTarget = nil  -- To store the target player while Right Click is held
local espPlayers = {}

local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
    AimbotButton.Text = aimbotEnabled and "Aimbot: ON" or "Aimbot: OFF"
    AimbotButton.BackgroundColor3 = aimbotEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

local function toggleESP()
    espEnabled = not espEnabled
    ESPButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    ESPButton.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

AimbotButton.MouseButton1Click:Connect(toggleAimbot)
ESPButton.MouseButton1Click:Connect(toggleESP)

-- Aimbot Function: Lock onto the player's head directly
local function aimAtPlayer(target)
    if target and target.Character and target.Character:FindFirstChild("Head") then
        local targetHead = target.Character.Head
        -- Aim directly at the target's head
        local aimPosition = targetHead.Position
        -- Calculate the direction from the camera to the target's head
        local direction = (aimPosition - Camera.CFrame.Position).unit
        -- Set the camera's CFrame to look at the aimPosition (head)
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, aimPosition)
    end
end

-- ESP Function: Highlight players' entire body
local function highlightPlayers()
    -- Clear previous ESP players
    espPlayers = {}

    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Head") then
            local color = player.Team == game.Players.LocalPlayer.Team and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
            -- Create or update ESP for this player
            local character = player.Character
            local headPos = character.Head.Position
            local humanoidRootPartPos = character.HumanoidRootPart.Position
            local screenPosHead = Camera:WorldToScreenPoint(headPos)
            local screenPosRoot = Camera:WorldToScreenPoint(humanoidRootPartPos)

            -- Add the player to the ESP list for rendering purposes
            table.insert(espPlayers, {
                player = player,
                screenPosHead = screenPosHead,
                screenPosRoot = screenPosRoot,
                color = color,
            })
        end
    end
end

-- Update functions: Run every frame to check for Aimbot and ESP
local lastESPUpdate = tick()
RunService.Heartbeat:Connect(function()
    if espEnabled and tick() - lastESPUpdate >= 1 then
        highlightPlayers()
        lastESPUpdate = tick()
    end

    if aimbotEnabled and aimbotTarget then
        aimAtPlayer(aimbotTarget)  -- Aim at the stored target while Right Click is held
    end
end)

-- Toggle GUI visibility with Right Shift key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.RightShift then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

-- Detect Right Mouse Button press and hold to lock aimbot onto closest player
local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2) -- Center of the screen

    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Head") and player ~= game.Players.LocalPlayer then
            local headPos = player.Character.Head.Position
            local screenPos = Camera:WorldToScreenPoint(headPos)
            local distanceToCenter = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude

            -- Track the closest player
            if distanceToCenter < closestDistance then
                closestPlayer = player
                closestDistance = distanceToCenter
            end
        end
    end

    return closestPlayer
end

-- Right Mouse Button Hold to lock aimbot onto the closest player
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right Mouse Button (MouseButton2)
        if aimbotEnabled then
            aimbotTarget = getClosestPlayer()  -- Lock aimbot onto closest player
        end
    end
end)

-- Right Mouse Button Release to stop locking aimbot
UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right Mouse Button (MouseButton2)
        aimbotTarget = nil  -- Stop locking onto any player
    end
end)

-- Highlight ESP when ESP button is clicked
ESPButton.MouseButton1Click:Connect(function()
    highlightPlayers()  -- Refresh ESP list of players
end)

-- Draw ESP for all players in the game
RunService.Heartbeat:Connect(function()
    if espEnabled then
        for _, espPlayer in pairs(espPlayers) do
            local player = espPlayer.player
            local screenPosHead = espPlayer.screenPosHead
            local screenPosRoot = espPlayer.screenPosRoot
            local color = espPlayer.color

            -- Draw a rectangle around the whole player body using the head and humanoid root part positions
            local width = math.abs(screenPosRoot.X - screenPosHead.X)
            local height = math.abs(screenPosRoot.Y - screenPosHead.Y)

            local espBox = Instance.new("Frame")
            espBox.Size = UDim2.new(0, width, 0, height)
            espBox.Position = UDim2.new(0, screenPosHead.X - width / 2, 0, screenPosHead.Y - height / 2)
            espBox.BackgroundColor3 = color
            espBox.BackgroundTransparency = 0.5  -- Semi-transparent for the box
            espBox.BorderSizePixel = 0  -- Remove border
            espBox.Parent = ScreenGui

            -- Remove the ESP box after a short duration to avoid cluttering
            game.Debris:AddItem(espBox, 0.1)
        end
    end
end)
