-- Services
local player = game.Players.LocalPlayer
local playerGui = player.PlayerGui
local players = game:GetService("Players")
local camera = game.Workspace.CurrentCamera
local UIS = game:GetService("UserInputService")
local tweenService = game:GetService("TweenService")
local character = player.Character or player.CharacterAdded:Wait()

-- Create ScreenGui if it doesn't exist
local screenGui = playerGui:FindFirstChild("AimbotESP") or Instance.new("ScreenGui")
screenGui.Name = "AimbotESP"
screenGui.Parent = playerGui

-- Variables
local aimbotEnabled = false
local espEnabled = false
local targetPlayer = nil
local holdingRightClick = false

-- Create Frame for GUI
local gui = Instance.new("Frame")
gui.Size = UDim2.new(0, 200, 0, 200)
gui.Position = UDim2.new(0.5, -100, 0.5, -100)  -- Centering the GUI on the screen
gui.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
gui.Parent = screenGui

-- Create Aimbot Button
local aimbotButton = Instance.new("TextButton")
aimbotButton.Size = UDim2.new(0, 180, 0, 40)
aimbotButton.Position = UDim2.new(0, 10, 0, 10)
aimbotButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
aimbotButton.TextColor3 = Color3.fromRGB(255, 255, 255)
aimbotButton.Text = "Toggle Aimbot"
aimbotButton.Parent = gui
aimbotButton.MouseButton1Click:Connect(function()
    aimbotEnabled = not aimbotEnabled
    if aimbotEnabled then
        print("Aimbot Enabled")
    else
        print("Aimbot Disabled")
    end
end)

-- Create ESP Button
local espButton = Instance.new("TextButton")
espButton.Size = UDim2.new(0, 180, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 60)
espButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
espButton.Text = "Toggle ESP"
espButton.Parent = gui
espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    if espEnabled then
        print("ESP Enabled")
        updateESP()
    else
        print("ESP Disabled")
        -- Remove ESP for all players
        for _, targetPlayer in pairs(players:GetPlayers()) do
            removeESP(targetPlayer)
        end
    end
end)

-- Function to create ESP for a player
local function createESP(targetPlayer)
    if targetPlayer.Character then
        local head = targetPlayer.Character:FindFirstChild("Head")
        if head then
            -- Create a BillboardGui to display above the head
            local espGui = Instance.new("BillboardGui")
            espGui.Adornee = head
            espGui.Size = UDim2.new(0, 100, 0, 100)
            espGui.StudsOffset = Vector3.new(0, 2, 0)  -- Position above the head
            espGui.Parent = screenGui

            -- Create a Frame inside the BillboardGui
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1, 0, 1, 0)
            frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)  -- Red color
            frame.BackgroundTransparency = 0.5  -- Semi-transparent
            frame.BorderSizePixel = 0
            frame.Parent = espGui
        end
    end
end

-- Function to remove ESP from a player
local function removeESP(targetPlayer)
    for _, gui in pairs(screenGui:GetChildren()) do
        if gui:IsA("BillboardGui") and gui.Adornee and gui.Adornee.Parent == targetPlayer.Character then
            gui:Destroy()
        end
    end
end

-- Function to update ESP (check for new players or removed players)
local function updateESP()
    -- Create ESP for all players in the game
    for _, targetPlayer in pairs(players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character then
            createESP(targetPlayer)  -- Create ESP for the player
        end
    end
end

-- Function to find the closest player to the center of the screen
local function getClosestPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local mousePos = UIS:GetMouseLocation()
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

    for _, targetPlayer in pairs(players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character then
            local head = targetPlayer.Character:FindFirstChild("Head")
            if head then
                local headPosition = camera:WorldToScreenPoint(head.Position)
                local distance = (Vector2.new(headPosition.X, headPosition.Y) - screenCenter).Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    closestPlayer = targetPlayer
                end
            end
        end
    end

    return closestPlayer
end

-- Aimbot Logic (locking onto the closest player's head with smoothness)
local function aimbot()
    if aimbotEnabled and targetPlayer then
        local head = targetPlayer.Character:FindFirstChild("Head")
        if head then
            -- Calculate the position of the head on the screen
            local headPosition = camera:WorldToScreenPoint(head.Position)

            -- Use TweenService to smoothly move the camera
            local cameraPosition = camera.CFrame.Position
            local targetPosition = head.Position

            -- Create a smooth transition from the current camera position to the target (head position)
            local goal = {}
            goal.CFrame = CFrame.new(cameraPosition, targetPosition)

            local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
            local tween = tweenService:Create(camera, tweenInfo, goal)
            tween:Play()
        end
    end
end

-- Toggle GUI Visibility with Right Shift
local guiVisible = true
UIS.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.RightShift then
        guiVisible = not guiVisible
        gui.Visible = guiVisible
    end
end)

-- Handle Right Click to enable aimbot lock
UIS.InputBegan:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right-click hold
        holdingRightClick = true
    end
end)

UIS.InputEnded:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then  -- Right-click release
        holdingRightClick = false
    end
end)

-- Continuously update Aimbot and ESP
while true do
    if aimbotEnabled and holdingRightClick then
        targetPlayer = getClosestPlayer()  -- Find the closest player to the center of the screen
        aimbot()  -- Lock onto the player's head smoothly
    end
    if espEnabled then
        updateESP()  -- Continuously update ESP
    end
    wait(0.1)  -- Update every 0.1 seconds for smooth aimbot/ESP behavior
end
