-- Initialize Services
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Camera = game:GetService("Workspace").CurrentCamera
local RunService = game:GetService("RunService")

-- Create the GUI elements
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui

local AimbotButton = Instance.new("TextButton")
AimbotButton.Parent = ScreenGui
AimbotButton.Text = "Aimbot: OFF"
AimbotButton.Size = UDim2.new(0, 200, 0, 50)
AimbotButton.Position = UDim2.new(0, 0, 0, 50)
AimbotButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

local ESPButton = Instance.new("TextButton")
ESPButton.Parent = ScreenGui
ESPButton.Text = "ESP: OFF"
ESPButton.Size = UDim2.new(0, 200, 0, 50)
ESPButton.Position = UDim2.new(0, 0, 0, 100)
ESPButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

-- Aimbot and ESP state variables
local aimbotEnabled = false
local espEnabled = false

local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
    AimbotButton.Text = aimbotEnabled and "Aimbot: ON" or "Aimbot: OFF"
    AimbotButton.BackgroundColor3 = aimbotEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

local function toggleESP()
    espEnabled = not espEnabled
    ESPButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    ESPButton.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end

AimbotButton.MouseButton1Click:Connect(toggleAimbot)
ESPButton.MouseButton1Click:Connect(toggleESP)

-- Aimbot Function: Lock onto the closest player's head to the center of the screen
local function aimAtPlayer(target)
    if target and target.Character and target.Character:FindFirstChild("Head") then
        local targetHead = target.Character.Head
        -- Calculate the direction from the camera to the player's head
        local direction = (targetHead.Position - Camera.CFrame.Position).unit
        -- Set the camera's CFrame to look at the player's head
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetHead.Position)
    end
end

-- ESP Function: Highlight players and refresh every second
local function highlightPlayers()
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Head") then
            local color = player.Team == game.Players.LocalPlayer.Team and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
            -- Create or update ESP for this player
            -- Example: Draw a box around the player's head (this part can be customized for your game)
            local headPos = player.Character.Head.Position
            local screenPos = Camera:WorldToScreenPoint(headPos)
            -- You can draw a GUI element here or use a 3D ESP, depending on your game's engine.
        end
    end
end

-- Update functions: Run every frame to check for Aimbot and ESP
local lastESPUpdate = tick()
RunService.Heartbeat:Connect(function()
    if espEnabled and tick() - lastESPUpdate >= 1 then
        highlightPlayers()
        lastESPUpdate = tick()
    end

    if aimbotEnabled then
        -- Find the closest player to the center of the screen
        local closestPlayer = nil
        local closestDistance = math.huge
        local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2) -- Center of the screen

        for _, player in pairs(Players:GetPlayers()) do
            if player.Character and player.Character:FindFirstChild("Head") and player ~= game.Players.LocalPlayer then
                local headPos = player.Character.Head.Position
                local screenPos = Camera:WorldToScreenPoint(headPos)
                local distanceToCenter = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude

                -- Track the closest player
                if distanceToCenter < closestDistance then
                    closestPlayer = player
                    closestDistance = distanceToCenter
                end
            end
        end

        if closestPlayer then
            aimAtPlayer(closestPlayer)
        end
    end
end)

-- Toggle GUI visibility with Left Shift key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.LeftShift then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)
