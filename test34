--// GUI Creation
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local ESPButton = Instance.new("TextButton")

--// Parent to Player's PlayerGui
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

--// Main Frame Properties
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.Position = UDim2.new(0.85, 0, 0.5, 0) -- Right bottom
MainFrame.Size = UDim2.new(0, 150, 0, 50)
MainFrame.Active = true
MainFrame.Draggable = true

--// ESP Button Properties
ESPButton.Parent = MainFrame
ESPButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
ESPButton.Size = UDim2.new(0, 150, 0, 50)
ESPButton.Font = Enum.Font.SourceSans
ESPButton.Text = "Toggle ESP"
ESPButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPButton.TextSize = 20

--// Variables
local ESPEnabled = false
local roles = {}

--// Function to get player role (Custom logic for MM2)
local function GetPlayerRole(player)
    -- Replace this logic with the game's way of checking roles
    local role = player:FindFirstChild("Role") -- Example role logic
    if role then
        return role.Value
    end
    return "Civilian" -- Default to Civilian if no role is found
end

--// ESP Function
local function ToggleESP()
    ESPEnabled = not ESPEnabled

    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character then
            local highlight = player.Character:FindFirstChild("Highlight")
            if ESPEnabled and not highlight then
                -- Add ESP Highlight
                local espHighlight = Instance.new("Highlight")
                espHighlight.Parent = player.Character
                espHighlight.Adornee = player.Character

                -- Assign color based on role
                local role = GetPlayerRole(player)
                if role == "Murderer" then
                    espHighlight.FillColor = Color3.fromRGB(255, 0, 0) -- Red for Murderer
                elseif role == "Sheriff" then
                    espHighlight.FillColor = Color3.fromRGB(0, 0, 255) -- Blue for Sheriff
                else
                    espHighlight.FillColor = Color3.fromRGB(0, 255, 0) -- Green for Civilians
                end

                espHighlight.OutlineColor = Color3.fromRGB(0, 0, 0)
                espHighlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            elseif not ESPEnabled and highlight then
                -- Remove ESP Highlight
                highlight:Destroy()
            end
        end
    end
end

--// Update ESP Colors Based on Roles
local function UpdateESPColors()
    if ESPEnabled then
        for _, player in pairs(game.Players:GetPlayers()) do
            if player.Character then
                local highlight = player.Character:FindFirstChild("Highlight")
                if highlight then
                    -- Assign color based on role
                    local role = GetPlayerRole(player)
                    if role == "Murderer" then
                        highlight.FillColor = Color3.fromRGB(255, 0, 0) -- Red for Murderer
                    elseif role == "Sheriff" then
                        highlight.FillColor = Color3.fromRGB(0, 0, 255) -- Blue for Sheriff
                    else
                        highlight.FillColor = Color3.fromRGB(0, 255, 0) -- Green for Civilians
                    end
                end
            end
        end
    end
end

--// Reset ESP each round
local function ResetESP()
    for _, player in pairs(game.Players:GetPlayers()) do
        if player.Character then
            local highlight = player.Character:FindFirstChild("Highlight")
            if highlight then
                highlight:Destroy() -- Remove existing highlights
            end
        end
    end
end

--// Function to detect new rounds (Customize depending on the game's round system)
local function OnRoundStart()
    -- Reset ESP and update roles each round
    ResetESP()
    wait(1) -- Wait for characters to load
    UpdateESPColors()
end

--// Role Update Listener (Assumes there's a way to detect role change)
game.Players.PlayerAdded:Connect(function(player)
    player.Changed:Connect(function()
        UpdateESPColors()
    end)
end)

--// Button Click Events
ESPButton.MouseButton1Click:Connect(function()
    ToggleESP()
end)

--// Periodically Refresh the ESP for new players or role changes
while true do
    wait(5) -- Refresh every 5 seconds
    UpdateESPColors()
end

--// Listen for round start (This event should match the round system of the game)
-- Replace this section with the actual round detection logic:
game.ReplicatedStorage.RoundStart.OnClientEvent:Connect(function()
    OnRoundStart()
end)

game.ReplicatedStorage.RoundEnd.OnClientEvent:Connect(function()
    ResetESP() -- Clean up ESP at the end of each round
end)
